<html>
  <head>
    <link rel="stylesheet" href="../home.css" />
  </head>
  <body>
    <div class="parent">
      <div class="leftSide">

        <div class="userinfo sign-out">
          <div><%= name %></div>
          <div>logout</div>
        </div>
        <div class="newFolder">
          <div onclick="showAddFolderForm()">+ new folder</div>
          <div class="newFolderForm hidden">
            <form id="addFolderForm">
              <input class="newFolderInput" placeholder="folder name" name="newFolderName">
              <button type="button" onclick="addFolder(event)">add</button>
            </form>
          </div>
          <div>
            <form action="/newFolder" method="POST">

            </form>
          </div>
        </div>
        <div class="allFolders">
          <% if (folders && folders.length > 0) { %> <% folders.slice(0,
          10).forEach(folder => { %>
          <div class="<%folder.name%>" data-folder-id="<%= folder.id %>">
            <a href="/home/<%=folder.id%>"><%= folder.name %></a>
          </div>
          <% }) %> <% } %>
        </div>
        <div class="viewAll"><a href="/home/view-all-folders">view all folders</a></div>
        <div class="trash">
          <img class="trash icon" />
          <a href="/home/trash">trash</a>
        </div>
      </div>

      <div class="rightSide">
          <% if (view === "empty") { %>
            <div><%= emptyMessage %></div>
         <% } %>

         <% if (view === "trash") { %>
          <div> Trash </div>
          <div>
            <% if (!trashedFiles) { %>
              <div><%= emptyMessage %></div>
            <% } else { %>
              <% trashedFiles.forEach((file) => { %>
                <div>
                  <div><%= file.name %></div>
                  <div>
                    <div>restore</div>
                    <div>delete</div> 
                  </div>
                </div>
              <% }) %>
            <% } %>

        <% } %>

        <% if (view === "folder") { %>
          <div class="folderName">
            <div class="enteredFolder"><%=currentFolder.name%></div>
          </div>
          <div class="filesIn SelectedFolderGrid">
            <div>
              <div onclick="">+ new file</div>
            </div>
            <div>
              <label hidden for="searchBar"></label>
              <input class="searchBar" name="searchBar" placeholder="search" />
            </div>
            <div class="options hidden">
              <div>
                <div><a class="linkTo">open</a></div>
                <div class="download">download</div>
                <div class="edit">edit</div>
                <div class="editForm hidden">
                  <form action="/updateFileName" method="POST">
                      <label>name:</label>
                      <input name="name" class="editFileName" >
                      <input hidden name="fileID" class="editFileNameId" >
                      <button type="submit">update</button>
                      <div>cancel</div>
                  </form>
                </div>
                <div onclick="moveTo(event)">move to</div>
                <div class="moveTo hidden">
                  <form>
                    <label>from:</label>
                    <input>
                    <label>to:</label>
                    <input>
                  </form>
                </div>
                <div>
                    <button type="button" class="delete" onclick="deleteFile()">delete</button>
                </div>
                <div class="x" onclick="closeOptions()">x</div>
              </div>
            </div>
            <div class="fileHolder">
              <% if (files) { %> 
              <% files.forEach((file) => { %>
              <div
                class="file"
                data-file-id="<%= file.ID%>"
                data-fileName="<%= file.name %>"
                onclick="openOptions(event)"
              >
                <div>preview if possible?</div>
                <div><%= file.name %></div>
              </div>
              <% }) %> <% } %>
            </div>
         <% } %>

           <% if (view === "all folders") { %>
          <div>All folders</div>

          <div class="folderGrid">
            <% folders.forEach(folder => { %>
              <div class="folderCard">
                <a href="/home/<%= folder.id %>"><%= folder.name %></a>
                <form action="/softDeleteFolder" method="POST">
                  <button>delete folder</button>
                </form>
              </div>
            <% }) %>
          </div>
        <% } %>

        <% if (view === "file") { %>
          <div class="fileHeader">
            <div><%= file.name %></div>
          </div>

          <div class="fileViewer">
            <p>File preview goes here</p>
          </div>
        <% } %>
      
        </div>
      </div>
    </div>
  </body>
  <script>
    let selectedFileID = null;

    function search() {
      const search = document.querySelector(".searchBar");
      search.addEventListener("input", (event) => {
        const query = e.target.value;
      });
    }

    function openOptions(event) {
      const optionsDiv = document.querySelector(".options");
      optionsDiv.classList.remove("hidden");

      const fileEl = event.currentTarget;
      const fileID = fileEl.target.dataset.fileID;
      const fileName = e.target.dataset.fileName;
      selectedFileID = fileEl.dataset.fileId;

      const download = document.querySelector(".download");

      const openLink = document.querySelector(".linkTo");
      openLink.href = `/home/${folderID}/${fileName}`;

      const edit = document.querySelector(".linkTo");
      edit.addEventListener("click", (event) => {
        const editForm = document.querySelector(".editForm");
        editForm.classList.remove("hidden");
        const editFileName = document.querySelector(".editFileName")
        editFileName.value = fileName;
        const editFileNameID = document.querySelector(".editFileNameId");
        editFileNameID.value = fileID;
      });

      const deleteBtn = document.querySelector(".delete");
      deleteBtn.addEventListener("click", (event) => {
        const deleteFileID = document.querySelector(".deleteFileID");
        deleteFileID.value = fileID;
      })

    }

    function closeOptions() {
      const search = document.querySelector(".searchBar");
      search.classList.add("hidden");
    }

    function moveTo(event){

    }

    function showAddFolderForm(){
      const newFolderShow = document.querySelector(".newFolderForm");
      newFolderShow.classList.toggle("hidden")
    }

    async function addFolder(event) {
    event.preventDefault();
    const input = document.querySelector(".newFolderInput");
    const name = input.value;

    if (!name) return;

    try {
      const res = await fetch("/newFolder", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ newFolderName: name }),
      });

      console.log("status:", res.status);
      if (!res.ok) {
        throw new Error("Failed to create folder");
      } else {

      const folder = await res.json();

      const folderList = document.querySelector(".allFolders");

      const foldersRendered = folderList.children;
      if (foldersRendered.length > 10) {
        foldersRendered[foldersRendered.length - 1].remove();
      };

      const div = document.createElement("div");
      div.innerHTML = `<a href="/home/${folder.id}">${folder.name}</a>`;

      folderList.prepend(div);

      input.value = "";
      document
        .querySelector(".newFolderForm")
        .classList.add("hidden");
      }

    } catch (err) {
      console.error(err);
       alert(err.message);
    }
  }

  


  </script>
</html>
